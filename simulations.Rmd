---
title: "Appendix II: simulated landscapes"
output: pdf_document
header-includes:
    - \usepackage{booktabs}
---

```{r}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Required packages

In the first step, we load all of the required packages. Note that winmoveR (the package developed for this paper) can be installed using:

`devtools::install_github("laurajanegraham/winmoveR")`

Also required are NLMR and landscapetools:

`devtools::install_github("ropensci/NLMR", ref = "develop")`

`devtools::install_github("ropensci/landscapetools")`

Helper functions `ls_analyse()`, `ls_create()` and `torus_create()` are loaded at this stage, these are available from [put link to zenodo version of repo once created] (for now it's [here](github.com/laurajanegraham/UPSCALING/R)).

```{r setup}
# load required libraries
library(winmoveR)
library(plyr)
library(landscapetools)
library(NLMR)
library(R.utils)
library(tidyverse)
library(cowplot)

theme_set(theme_classic() + theme(strip.background = element_blank()))

# load required R functions
sourceDirectory("R")
```

## Simulation One: continuous variables

This simulation shows the use of the moving window based spatial structure measure for continuous variables which have finer scale variation than the resolution of analysis. This could be, for example, topographic or microclimate variation. 

### Simulated landscapes

We simulated landscapes using the mid-point displacement method (`nlm_mpd`) from the `NLMR` package [@Sciaini2018]. We simulated landscapes with three levels of spatial autocorrelation, and 100 replicates for each of these. The spatial autocorrelation of the landscape is controlled by the `roughness` parameter where a value of zero is a clustered landscape, and a value of one is a rough landscape. We generated landscapes of 65 x 65 cells using roughness = 0, 0.5, 1. We scaled each landscape to have a mean of zero, and a variance of one in order to facilitate comparison between landscapes. Example landscapes for each level of roughness are shown below. 

```{r sim_ls}
nrows <- ncols <- 65
roughness <- c(0, 0.5, 1)
radius <- c(1, 7, 17)
reps <- 1:100

# set up a table with all combinations of parameters
param_table <- expand.grid(ncol = ncols, nrow = nrows, roughness = roughness, 
                           radius = radius, reps = reps)

# simulate 65 x 65 landscapes with mean = 0, variance = 1 and variable roughness
sim_ls <- apply(param_table, 1, function(x) ls_create(x))

# combine all runs into one dataframe and only take the first replicate of each
# combination for plotting
cont_ls_df <- ldply(sim_ls, function(x) x$ls_df) %>% 
  filter(reps == 1, radius == 1)

# plot example landscapes
cont_ls_plot <- ggplot(cont_ls_df, aes(x = x, y = y, fill = layer)) + 
  geom_raster() + 
  coord_equal() + 
  scale_fill_viridis_c(name = "Continuous variable") + 
  theme(axis.text = element_blank(), axis.title = element_blank(), 
        axis.line = element_blank(), axis.ticks = element_blank()) + 
  facet_wrap(~roughness, ncol = 1) + 
  theme(strip.background = element_blank(), strip.text.x = element_blank(), 
        legend.position = "none")

cont_ls_plot
```

### Use winmover function

We used the `winmove` function from the [`winmoveR`](https://github.com/laurajanegraham/winmoveR) package to gain a moving-window based variance of the continuous variable at 3 different window sizes: 3 x 3 = small; 15 x 15 = medium; 35 x 35 = large. The window sizes represent the appropriate scale of effect of the continuous variable on the response. 

```{r contsim_winmove}
cont_res <- ldply(sim_ls, function(x) ls_analyse(x, fn = "var")) %>% 
  mutate(radius = factor(radius, 
                         labels = c("Small: 3 x 3", "Medium: 15 x 15", "Large: 35 x 35")), 
         roughness = factor(paste0("Roughness = ", roughness)))
```


### Results

```{r contsim_results}
cont_res_plot <- ggplot(cont_res, aes(x = radius, y = val)) + 
  geom_boxplot(lwd = 0.1, outlier.size = 0.5) + coord_flip() + 
  facet_wrap(~roughness, ncol = 1) +
  xlab("Moving window size") + ylab("MW Variance")

cont_figure <- plot_grid(cont_res_plot, cont_ls_plot, rel_widths = c(2, 1))
save(cont_figure, file = "results/contsim_figure.Rda")
cont_figure
```

Results of the moving window analysis of continuous variables for simulated landscapes. Variance within moving windows was calculated at three scales. Note that the landscape scale variance is 1 in all cases. 

We used a two-way analysis of variance in order to understand the effect of spatial structure in the landscape and the size of the moving window on the output measure. We focus on the effect size rather than the statistical significance due to the inflated sample size in simulated data. 

```{r}
cont_aov <- aov(val ~ roughness * radius, data = cont_res)
broom::tidy(cont_aov)
```

## Simulation Two: categorical variables

This simulation will show the use of the moving window-based spatial structure measure for categorical variables which have finer scale variation than the resolution of analysis. This is appropriate for more classical landscape ecology questions about habitat structure. 

### Simulated landscapes

We will use the simulated landscapes from the previous example, and use the `util_classify` function to classify into equal proportions of three habitat types. This will give us a landscape scale Shannon evenness of 1 for all landscapes (complete evenness). Example categorical landscapes for each level of roughness are shown below. 

```{r cat_ls}
cat_ls_df <- ldply(sim_ls, function(x) {
  ls <- util_classify(x$ls, weighting = rep(1/3, 3))
  ls_df <- raster::as.data.frame(ls, xy = TRUE)
  return(data.frame(t(x$params), ls_df))
}
) %>% 
  filter(reps == 1, radius == 1)

# plot example landscapes
cat_ls_plot <- ggplot(cat_ls_df, aes(x = x, y = y, fill = layer)) + 
  geom_raster() + 
  coord_equal() + 
  scale_fill_viridis_c() + 
  theme(axis.text = element_blank(), axis.title = element_blank(), 
        axis.line = element_blank(), axis.ticks = element_blank()) + 
  facet_wrap(~roughness, ncol = 1) + 
  theme(strip.background = element_blank(),strip.text.x = element_blank(), 
        legend.position = "none")

cat_ls_plot
```

### Use winmover function

We used the `winmove` function from the [`winmoveR`](https://github.com/laurajanegraham/winmoveR) package to gain a moving-window based Shannon evenness of the categorical variable at 3 different window sizes: 3 x 3 = small; 15 x 15 = medium; 35 x 35 = large. The window sizes represent the appropriate scale of effect of the continuous variable on the response. 

```{r catsim_winmove}
cat_res <- ldply(sim_ls, function(x) ls_analyse(x, fn = "diversity", lc_class = 0:2)) %>% 
  mutate(radius = factor(radius, 
                         labels = c("Small: 3 x 3", "Medium: 15 x 15", "Large: 35 x 35")), 
         roughness = paste0("Roughness = ", roughness))
```


### Results

```{r catsim_results}
cat_res_plot <- ggplot(cat_res, aes(x = radius, y = val)) + 
  geom_boxplot(lwd = 0.1, outlier.size = 0.5) + coord_flip() + 
  facet_wrap(~roughness, ncol = 1) +
  xlab("Moving window size") + ylab("MW Shannon") 

cat_figure <- plot_grid(cat_res_plot, cat_ls_plot, align = 'h', rel_widths = c(2, 1))
save(cat_figure, file = "results/catsim_figure.Rda")
cat_figure
```

Results of the moving window analysis of categorical variables for simulated landscapes. Shannon evenness within moving windows was calculated at three scales. Note that the landscape scale variance is 1 in all cases. 

Again, we used a two-way analysis of variance in order to understand the effect of spatial structure in the landscape and the size of the moving window on the output measure. 

```{r}
cat_aov <- aov(val ~ roughness * radius, data = cat_res)
broom::tidy(cat_aov)
```

## Session Info

```{r}
devtools::session_info()
```